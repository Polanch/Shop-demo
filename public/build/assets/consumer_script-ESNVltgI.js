document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".prod-pic").forEach(t=>{t.complete?t.classList.add("loaded"):(t.addEventListener("load",()=>t.classList.add("loaded")),t.addEventListener("error",()=>t.classList.add("loaded")))});const s=document.querySelector(".cart-box"),i=document.querySelector(".cart-window"),L=document.querySelector(".close-cart"),d=document.getElementById("dd-btn"),m=document.getElementById("drop-down-window"),p=document.querySelector(".cart-items"),f=document.querySelector(".total-amount");document.querySelector(".empty-cart-message");let n=JSON.parse(localStorage.getItem("cart"))||[];function r(){if(n.length===0){p.innerHTML='<p class="empty-cart-message">Your cart is empty</p>',f.textContent="$0.00",s.classList.remove("has-items");return}s.classList.add("has-items");let t="",e=0;n.forEach((a,c)=>{const o=a.price*a.quantity;e+=o,t+=`
                <div class="cart-item" data-index="${c}">
                    <img src="${a.image}" alt="${a.name}" class="cart-item-image">
                    <div class="cart-item-details">
                        <h4 class="cart-item-name">${a.name}</h4>
                        <p class="cart-item-price">$${a.price.toFixed(2)}</p>
                        <div class="cart-item-quantity">
                            <button class="qty-btn minus" data-index="${c}">-</button>
                            <span class="qty-display">${a.quantity}</span>
                            <button class="qty-btn plus" data-index="${c}">+</button>
                        </div>
                    </div>
                    <button class="remove-item" data-index="${c}">&times;</button>
                </div>
            `}),p.innerHTML=t,f.textContent=`$${e.toFixed(2)}`,s.querySelector("::after"),s.style.setProperty("--cart-count",`"${n.length}"`)}document.querySelectorAll(".add-to-cart-button").forEach(t=>{t.addEventListener("click",function(e){if(e.preventDefault(),this.disabled)return;const a=this.closest(".product-card"),c=parseInt(this.dataset.productId),o=a.querySelector(".product-name").textContent,u=a.querySelector(".product-price").textContent,x=parseFloat(u.replace("$","").replace(",","")),k=a.querySelector(".prod-pic").src,g=parseInt(this.dataset.stock)||0,v=n.findIndex(C=>C.product_id===c);if(v>-1)if(n[v].quantity<g)n[v].quantity+=1;else{alert(`Sorry, only ${g} items available in stock!`);return}else n.push({product_id:c,name:o,price:x,image:k,quantity:1,stock:g});localStorage.setItem("cart",JSON.stringify(n)),r(),this.textContent="Added!",this.style.background="#27ae60",setTimeout(()=>{this.textContent="Add to Cart",this.style.background=""},1e3)})}),p.addEventListener("click",function(t){t.stopPropagation();const e=parseInt(t.target.dataset.index);if(t.target.classList.contains("plus")){const a=n[e];a.quantity<a.stock?(n[e].quantity+=1,localStorage.setItem("cart",JSON.stringify(n)),r()):alert(`Sorry, only ${a.stock} items available in stock!`)}t.target.classList.contains("minus")&&(n[e].quantity>1?n[e].quantity-=1:n.splice(e,1),localStorage.setItem("cart",JSON.stringify(n)),r()),t.target.classList.contains("remove-item")&&(n.splice(e,1),localStorage.setItem("cart",JSON.stringify(n)),r())}),s.addEventListener("click",function(t){t.stopPropagation(),i.classList.toggle("active"),r()}),L.addEventListener("click",function(){i.classList.remove("active")});const S=document.querySelector(".checkout-button"),l=document.getElementById("payment-modal"),q=document.querySelector(".close-payment"),y=document.getElementById("payment-form"),E=document.querySelector(".payment-total"),h=document.getElementById("card-number"),I=document.getElementById("expiry"),b=document.getElementById("cvv");h.addEventListener("input",function(t){let e=t.target.value.replace(/\s/g,""),a=e.match(/.{1,4}/g)?.join(" ")||e;t.target.value=a}),I.addEventListener("input",function(t){let e=t.target.value.replace(/\D/g,"");e.length>=2&&(e=e.slice(0,2)+"/"+e.slice(2,4)),t.target.value=e}),b.addEventListener("input",function(t){t.target.value=t.target.value.replace(/\D/g,"")}),S.addEventListener("click",function(t){if(t.stopPropagation(),n.length===0){alert("Your cart is empty!");return}const e=n.reduce((a,c)=>a+c.price*c.quantity,0);E.textContent=`$${e.toFixed(2)}`,l.classList.add("active"),i.classList.remove("active")}),q.addEventListener("click",function(){l.classList.remove("active"),y.reset()}),l.addEventListener("click",function(t){t.target===l&&(l.classList.remove("active"),y.reset())}),y.addEventListener("submit",function(t){t.preventDefault();const e=n.reduce((o,u)=>o+u.price*u.quantity,0),a={items:n,total:e},c=document.querySelector(".confirm-payment-btn");c.textContent="Processing Payment...",c.disabled=!0,fetch("/consumer/checkout",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify(a)}).then(o=>o.json()).then(o=>{o.success?(n=[],localStorage.removeItem("cart"),alert("Payment successful! Order ID: "+o.order_id),window.location.reload()):alert("Error: "+(o.message||"Could not process order"))}).catch(o=>{console.error("Error:",o),alert("Error processing payment. Please try again.")}).finally(()=>{c.textContent="Confirm Payment",c.disabled=!1})}),d.addEventListener("click",function(t){t.stopPropagation(),d.classList.toggle("active"),m.classList.toggle("active")}),document.addEventListener("click",function(t){!i.contains(t.target)&&!s.contains(t.target)&&i.classList.remove("active"),!m.contains(t.target)&&!d.contains(t.target)&&(m.classList.remove("active"),d.classList.remove("active"))}),r()});
